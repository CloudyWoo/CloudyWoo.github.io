---
layout: single

title:  "[TIL] 2022-08-18 - Service (1)"
excerpt: "쿠버네티스 서비스에 대해 알아보자."

categories:
    - Kubernetes
tags: [DevOps, Kubernetes]

toc: true
author_profile: false
sidebar:
    nav: "docs"

date: 2022-08-18
last_modified_at: 2022-08-18
---

# 5장. 서비스: 클라이언트가 파드를 검색하고 통신을 가능하게 함

다루는 내용
- 단일 주소로 파드를 노출시키는 서비스 리소스 만들기
- 클러스터 안에서 서비스 검색
- 외부 클라이언트에 서비스 노출
- 파드가 서비스할 준비가 되었는지 제어하는 방법
- 서비스 문제 해결

### 클러스터 내에서 서비스를 사용하고 동작 방식을 살펴보자.
``` shell
kubectl create -f kubia-svc.yaml
kubectl get svc
```

서비스에 할당된 IP 주소가 10.96.114.58이다.
클러스터 IP이므로 내부에서만 액세스할 수 있다.

#### 서비스 생성
- 서비스를 지원하는 파드가 여러 개일 때 뒷단의 모든 파드로 로드밸런싱이 된다.
- 정확히 어떤 파드가 서비스의 일부분인지 아닌지를 어떻게 정의할까?
  - 레이블 셀렉터? 
    - rc와 기타 파드 컨트롤러에서 레이블 셀렉터를 이용해 동일한 세트에 속하는 파드를 지정한다.

#### 서비스 생성
- kubectl expose
- Kubrnetes API 서버에 YAML 게시

``` yaml
apiVersion: v1
kind: Service
metadata:
  name: kubia
spec:
  ports:
  - port: 80
    targetPort: 80
  selector:
    app: kubia

# 서비스가 사용할 포트: 80
# 서비스가 포워드할 컨테이너 포트: 8080
# app=kubia: 레이블이 있는 모든 파드가 이 서비스에 포함된다.
```
=> 위 yaml 파일로 만들어진 서비스는 포트 80의 연결을 허용하고,
각 연결을 app=kubia 레이블 셀렉터와 일치하는 파드의 포트 8080으로 라우팅한다.


#### 서비스 검사
kubectl get svc
- 네임스페이스의 모든 서비스 리소스 조회
- 내부 클러스터 IP가 할당되었는지 확인 

#### 클러스터 내에서 서비스 테스트
몇 가지 방법으로 클러스터 내에서 서비스로 요청을 보낼 수 있다.
1. 서비스의 클러스터 IP로 요청 보내고 응답을 로그로 남기는 파드 생성
   파드의 로그를 검사해 서비스의 응답이 무엇인지 확인 가능
2. 쿠버네티스 노드로 ssh 접속하고 curl 명령 실행
3. kubectl exec 명령어로 기존 파드에서 curl 명령 실행

#### 실행 중인 컨테이너에 원격으로 명령 실행
- 컨테이너의 내용, 상태, 환경을 검사할 때 유용

##### kubectl get pods 명령어로 파드를 조회
kubectl exec <rc로 생성된 pod명> --curl -s http://<ClusterIP>
- exec 명령어의 대상으로 하나를 선택
- 서비스의 클러스터 IP를 알아야 한다.


#### 서비스의 세션 어피니티 구성
위의 kubectl exec 명령을 여러 번 실행 시
실행할 때마다 동일한 클라이언트에서 요청하더라도 **서비스 프록시**가 
임의의 파드를 선택해 연결을 다시 전달(forward)하기 때문에 요청할 때마다 다른 파드가 선택된다.

Q. 만약 특정 클라이언트의 모든 요청 -> 매번 같은 파드로 리디렉션하려면?
A. 세션 어피니티(sessionAffinity) 속성을 기본값 None 대신 ClientIP로 설정
R. 서비스 프록시는 동일한 클라이언트 IP의 모든 요청을 동일한 파드로 전달

쿠버네티스 서비스 세션 어피니티 종류
- None
- ClientIP

쿠키 기반 세션 어피니티(cookie-based session affinity) 옵션이 없지만
쿠버네티스 서비스가 HTT

#### 동일한 서비스에서 여러 개의 포트 노출

#### 이름이 지정된 포트 사용

---

#### 서비스 검색
1. **환경변수**를 통한 서비스 검색
2. **DNS**를 통한 서비스 검색
3. **FQDN**를 통한 서비스 연결

---

## 5.2 클러스터 외부에 있는 서비스 연결
### 5.2.1 서비스 엔드포인트 소개
### 5.2.2 서비스 엔드포인트 수동 구성
### 5.2.3 외부 서비스를 위한 별칭 생성

---

## 5.3 외부 클라이언트에 서비스 노출
### 5.3.1 노드포트 서비스 사용
#### 노드포트 서비스 생성
#### 노드포트 서비스 확인
#### 외부 클라이언트 노드포트 서비스에 액세스할 수 있도록 방화벽 규칙 변경

---





서비스의 기본 목적은 파드 그룹을 클러스터의 다른 파드에 노출시키는 것이지만
대개 서비스를 외부로 노출하기를 원할 것이다.


---





